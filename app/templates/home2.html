{% extends 'base.html' %}

{% block body %}
<div class="justify-content-center container-fluid p-0 m-0">
    <div class="col-7 justify-content-center mx-auto p-0 m-0">

        <div class="justify-content-center p-0 m-0" style="flex-wrap: wrap;">

            <!-- Main Panel -->
            <div class="banner">
                <div class="row">
                    <div class="text-center justify-content-center p-3 pb-0 mb-0 mx-auto mt-4">
                        <h2 style="color: black;">Diabetes Data and Hypothesis Hub (D2H2)</h2>
                        <h5 class="m-2 mb-0" style="color: black;"> A platform that facilitates data-driven hypothesis
                            generation
                            for the diabetes and related metabolic disorder research community.
                        </h5>
                    </div>
                </div>
                <div hidden>
                    <div id="human-bulk-num">{{ numstudies[0] }}</div>
                    <div id="mouse-bulk-num">{{ numstudies[1] }}</div>
                    <div id="human-sc-num">{{ numstudies[2] }}</div>
                    <div id="mouse-sc-num">{{ numstudies[3] }}</div>
                </div>
            </div>


            <div class="row justify-content-center text-center">

                <div class="p-2 pt-0 mt-0 text-center col-lg-4 col-sm-6">
                    <p>
                        Curated transcriptomics datasets from various Type 2 Diabetes studies are made available for
                        download,
                        visualization, and enrichment analysis.
                    </p>
                    <h5 style="font-size: 16px;">Processed Bulk RNA-seq, Microarray, and scRNA-seq Studies</h5>
                    <div class="col mb-4">
                        <div class="row">
                            <div class="col text-center mb-3">
                                <h6>Human</h6>
                                <div class="countup num-style" style="font-size: 30px;">{{ numstudies[0] + numstudies[2]
                                    }}</div>
                            </div>
                            <div class="col text-center mb-3">
                                <h6>Mouse</h6>
                                <div class="countup num-style" style="font-size: 30px;">{{ numstudies[1] + numstudies[3]
                                    }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="vertical ml-5" style="margin-top: 6%">
                    <a href="{{ url_for('species_or_viewerpg', species_or_gse='human') }}">
                        <button class="learn-more">
                            <span class="circle" aria-hidden="true">
                                <span class="icon arrow"></span>
                            </span>
                            <span class="button-text">Explore Datasets</span>
                        </button></a>
                </div>
            </div>
        </div>
        <div class="vertical mt-4" id="chat-section" style="border-style: solid; border-radius: 2rem; border-color: rgb(184, 184, 184); width: 100%; overflow: auto;">
            <div id="chat-bubbles-section" style="overflow: auto;">
                <div class="chat chat-start mb-1" id="chat-intro" style="display: none;"> 
                    <div class="chat-image avatar pl-2" style="width: 50px">
                        <img src="static/img/d2h2_chat_bot.png"/>
                    </div>
                    <div class="chat-header">
                        D2H2
                    </div>
                    <div class="chat-bubble chat-bubble-info" style="background-color: #d3d3d3">I am an AI-powered chat
                        interface designed to help answer gene and gene set related queries. Please start by entering a question. 
                    </div>
                </div>
            </div>
        </div>

        <div id="query-section" class="col m-2 mx-right mb-5">
            <div class="vertical">
                <div class="input-wrapper row mt-3" style="flex-wrap: nowrap;">
                    <input id="gpt-query" style="right: 0rem; width: 60rem;" type="text"
                        placeholder="Enter a gene related query..." name="text" class="input pr-0 mr-0">
                    <button id="gpt-query-button" class="pl-0 ml-0 query-submit"
                        style="width: 40px; min-width: 40px; height: 55px; top: 0rem; left: .2rem; font-size: xx-large; position: relative">
                        <img src="static/img/doublearrow.png" style="width: 60%" alt="Query">
                    </button>
                </div>
                <p class="m-0 p-0 pt-2" style="font-size: smaller; max-width: 88%;">Try an example:
                    <a class="q-example" id="q-example1" style="color: rgb(10, 13, 149); font-size: small;">
                        In what tissues is STAT3 expressed?
                    </a>,
                    <a class="q-example" id="q-example2" style="color:rgb(10, 13, 149); font-size: small;">
                        What transcription factors regulate my geneset?
                    </a>,
                    <a class="q-example" id="q-example3" style="color:rgb(10, 13, 149); font-size: small;">
                        What diabetes related signatures are related to AKT1?
                    </a>,
                    <a class="q-example" id="q-example4" style="color:rgb(10, 13, 149); font-size: small;">
                        What small molecules might act as reversers for my up and down genesets?
                    </a>,
                    <a class="q-example" id="q-example5" style="color:rgb(10, 13, 149); font-size: small;">
                        In what diabetes related signatures is my geneset enriched?
                    </a>

                </p>
            </div>
        </div>


    </div>
</div>
{% endblock %}
</div>

{% block footer %}
<script type="module">
    import { human_list, mouse_list, processes, chatN, geneset_entries, geneset_buttons, geneset_buttons_up_down } from '../static/js/modules/constants.js';
    import { gen_table, gene_signatures, generanger_plot, geo_reverse, single_gene_perturbations, l1000_reverse, query_gwas, query_enrichr_tfs, loadCorrelation, query_komp } from '../static/js/modules/single-gene-queries.js';
    import { geneset_signatures, geneset_enrichment, geneset_kea3, geneset_chea3, geneset_sigcomlincs } from '../static/js/modules/geneset-queries.js';
    import { parse_gene, select_option, runFindQuery, run_process_gene } from '../static/js/modules/query.js';
    const process_dict = await processes;

    var new_process = true;
    var chat_num = 0;
    var process_info = {};
    var curr_arg = '';
    var options = [];

    async function reset_process() {
        new_process = true;
        process_info = {};
        curr_arg = '';
        options = [];
    }

    async function submit_gene_set() {
    var geneset = '';
    var geneset_up = '';
    var geneset_down = '';

    if (document.getElementById(`enter-geneset${chat_num}`).style.display == "flex") {
        var inputvalue = document.getElementById(`text-area${chat_num}`).value;
        var file = document.getElementById(`gene-file${chat_num}`).value;
        var section = `gene-file${chat_num}`;
        geneset;

        if (inputvalue) {
            geneset = inputvalue.split("\n").join(',')
        }

        if (file) {
            geneset = await loadFileAsText(section, ",");
        }
    } else {
        var inputvalue_up = document.getElementById(`text-area-up${chat_num}`).value;
        var inputvalue_down = document.getElementById(`text-area-down${chat_num}`).value;
        var file_up = document.getElementById(`gene-file-up${chat_num}`).value;
        var file_down = document.getElementById(`gene-file-down${chat_num}`).value;
        var section_up = `gene-file-up${chat_num}`;
        var section_down = `gene-file-down${chat_num}`;

        if (inputvalue_up) {
            geneset_up = inputvalue_up.split("\n").join(',')
        }
        if (file_up) {
            geneset_up = await loadFileAsText(section_up, ",");
        }

        if (inputvalue_down) {
            geneset_down = inputvalue_down.split("\n").join(',')
        }

        if (file_down) {
            geneset_down = await loadFileAsText(section_down, ",");
        }
    }
    console.log(geneset_up, geneset_down)
    process_info['geneset'] = geneset;
    process_info['up'] = geneset_up;
    process_info['down'] = geneset_down;
    run_process_gene(process_info, chat_num);
    chat_num++;
    chat_num++;
    await reset_process();
}

    async function ask_questions() {
        var response = document.getElementById('gpt-query').value.trim();
        if (response != '') {
                document.getElementById("chat-section").appendChild(chatN('end', chat_num, '#d3d3d3', response));
                await $(`#chat-${chat_num}`).fadeIn(1000);
                chat_num++;   
        }
        if (process_info['geneSymbol'] == '') { 
            const [gene, species] = await parse_gene(response);
            if (gene == '') {
                document.getElementById("chat-section").appendChild(chatN('start', chat_num, '#d3d3d3', "I did not recognize that gene symbol, please try again."));
                await $(`#chat-${chat_num}`).fadeIn(2000);
                chat_num++;  
                return;
            } else {
                process_info['geneSymbol'] = gene;
                process_info['species'] = species;
            }
        }
        const qs = process_dict[process_info.input][process_info.output].questions
        if (curr_arg != '') {
            const res = await select_option(response, options);
            process_info[curr_arg] = res;
        }
        for (let i = 0; i< qs.length; i++) {
            if (!(qs[i].arg in process_info)) {
                document.getElementById("chat-section").appendChild(chatN('start', chat_num, '#d3d3d3', qs[i].q + ' The options include: ' + qs[i].options.join(', ')));
                await $(`#chat-${chat_num}`).fadeIn(2000);
                chat_num++;
                curr_arg = qs[i].arg;
                options = qs[i].options;
                return;
            }
        }
        let process_info_copy = {...process_info};
        let chat_num_copy = chat_num.valueOf()
        await run_process_gene(process_info_copy, chat_num);
        chat_num++;
        chat_num++;
        await reset_process();
    }


    async function run_chat() {
        console.log(chat_num)
        var q = document.getElementById('gpt-query').value.trim();
        if (q != '') {
            document.getElementById("chat-section").appendChild(chatN('end', chat_num, '#d3d3d3', q))
            $(`#chat-${chat_num}`).fadeIn(2000)
            
            setTimeout(async () => {
                chat_num++;
                var response = await runFindQuery(q);
                if (response['response'] == 1) {
                    document.getElementById("chat-section").appendChild(chatN('start', chat_num, '#d3d3d3', "I'm sorry, I don't understand the your question. Please try again."));
                    await $(`#chat-${chat_num}`).fadeIn(2000);
                    chat_num++;
                    return;
                }
                new_process = false;
                process_info = response;
                if (response['input'] == '[Gene]') {
                    if (response['geneSymbol'] == '') {
                        document.getElementById("chat-section").appendChild(chatN('start', chat_num, '#d3d3d3', 'Please provide a gene symbol'))
                        await $(`#chat-${chat_num}`).fadeIn(2000);
                        chat_num++;
                    } else {
                        document.getElementById('gpt-query').value = '';
                        ask_questions();
                    }
                } else if (response['input'] == '[GeneSet]') {
                    document.getElementById("chat-section").appendChild(chatN('start', chat_num, '#d3d3d3',"Please enter your geneset:"))
                    await $(`#chat-${chat_num}`).fadeIn(2000)
                    chat_num++;
                    if (process_dict[response.input][response.output].args.includes('up')) {
                        document.getElementById("chat-section").appendChild(chatN('start', chat_num, '#d3d3d3', geneset_entries(chat_num + 1) + geneset_buttons_up_down(chat_num + 1)))
                    } else document.getElementById("chat-section").appendChild(chatN('start', chat_num, '#d3d3d3', geneset_entries(chat_num + 1) + geneset_buttons(chat_num + 1)))
                    document.getElementById(`submit_gene_set${chat_num + 1}`).addEventListener("click",  function() {
                        submit_gene_set(process_info);
                    });
                    await $(`#chat-${chat_num}`).fadeIn(2000);
                    chat_num++;
                }
            },
        2001);
        }
       
    }

    function run() {
        if (new_process) {
            run_chat();
        } else {
            ask_questions();
        }
        document.getElementById('gpt-query').value = '';
    }

    $("#gpt-query").on('keyup', function (e) {
        if (e.key === 'Enter') {
            run()
        }
    })

    $("#gpt-query-button").on('click', function (e) {
        run_chat()
    })


    document.getElementById("gpt-query").onfocus = function() {fadeChatIn()};

    async function fadeChatIn() {
        await $("#chat-section").fadeIn(1000);
        setTimeout(() => $("#chat-intro").fadeIn(), 1500)
        $("#chat-intro").fadeIn(2000)
        $('html, body').animate({
            scrollTop: $("#query-section").offset().top
        }, 1000);
    }

    function fillQuery(q) {
        document.getElementById('gpt-query').value = q;
        fadeChatIn();
        run();
        document.getElementById('gpt-query').value = '';
    }

    const exampleArray = Array.from(document.querySelectorAll('.q-example'));
    exampleArray.forEach((elt) => {
        document.getElementById(elt.id).addEventListener("click",  function() {
            fillQuery(elt.innerText);
        });
        }
    );
    

    const countupEls = document.querySelectorAll('.countup');
    countupEls.forEach(animateCountUp);
</script>
{% endblock %}